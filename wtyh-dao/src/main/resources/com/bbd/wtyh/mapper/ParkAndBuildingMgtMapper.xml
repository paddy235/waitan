<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bbd.wtyh.mapper.ParkAndBuildingMgtMapper">

    <select id="queryParkAndBuilding" parameterType="java.lang.String" resultType="com.bbd.wtyh.domain.vo.ParkAndBuildingVO">
        SELECT
        p.`name` as parkName,
        b.`name` as buildingName,
        DATE_FORMAT(p.create_date,'%Y.%c.%d') as createDate
        FROM
        park p, building b
        <where>
            p.park_id=b.park_id
            <if test="_parameter != null and _parameter != ''">
                and p.`name`=#{parkName}
            </if>
        </where>
    </select>

    <select id="queryParkByName" parameterType="java.lang.String" resultType="com.bbd.wtyh.domain.ParkDO">
        SELECT
            park_id as parkId,
            `name` as `name`,
            area_id as areaId,
            img_url as imgUrl
        FROM
            park
        WHERE `name`=#{parkName}
    </select>

    <update id="updateParkImgUrl" parameterType="com.bbd.wtyh.domain.ParkDO">
        UPDATE park SET img_url=#{imgUrl}, update_date=SYSDATE() WHERE park_id=#{parkId}
    </update>

    <select id="queryAllPark" resultType="com.bbd.wtyh.domain.ParkDO">
        SELECT `name` as `name`, area_id as areaId FROM area WHERE parent_id=104
    </select>

    <select id="queryBuildingCompany" parameterType="java.lang.String" resultType="com.bbd.wtyh.domain.vo.ParkAndBuildingVO">
        SELECT
            b.`name` as buildingName,
            count(1) as companyCount
        FROM
            park p, building b, company_building cb, company c
        WHERE
            p.park_id=b.park_id and b.building_id=cb.building_id and cb.company_id=c.company_id and p.`name`=#{parkName}
        GROUP BY b.`name`
    </select>

    <select id="queryBuildingFinCompany" parameterType="java.lang.String" resultType="com.bbd.wtyh.domain.vo.ParkAndBuildingVO">
        SELECT
            b.`name` as buildingName,
            count(1) as finCompanyCount
        FROM
            park p, building b, company_building cb, company c
        WHERE
            p.park_id=b.park_id and b.building_id=cb.building_id and cb.company_id=c.company_id and p.`name`=#{parkName} and c.company_type<![CDATA[>=]]>1
        GROUP BY b.`name`
    </select>

    <select id="queryBuildingCompanyNumber" parameterType="java.lang.String" resultType="com.bbd.wtyh.domain.vo.ParkAndBuildingVO">
        SELECT
            o.name as buildingName,
            (
            SELECT
                count(1)
            FROM
                park p,
                building b,
                company_building cb,
                company c
            WHERE
                p.park_id=b.park_id and b.building_id=cb.building_id and cb.company_id=c.company_id and b.`name` = o.name
            )
            as companyCount,
            (
            SELECT
                count(1)
            FROM
                park p,
                building b,
                company_building cb,
                company c
            WHERE
                p.park_id=b.park_id and b.building_id=cb.building_id and cb.company_id=c.company_id and b.`name` = o.name and c.company_type<![CDATA[>=]]>1
            )
            as finCompanyCount
        FROM
            building o
        WHERE
            o.park_id = (SELECT park_id FROM park WHERE name=#{parkName})
    </select>

    <insert id="addBuilding" parameterType="com.bbd.wtyh.domain.BuildingDO">
        INSERT INTO building(`name`, park_id, img_url, create_by, create_date, update_date) VALUES(#{name}, #{parkId}, #{imgUrl}, #{createBy}, SYSDATE(), SYSDATE())
    </insert>

    <delete id="delCompanyByCompanyName" parameterType="java.util.List">
        DELETE from
          company_building
        where
          company_id in
            (select company_id from company where name in
              <foreach item="item" index="index" collection="companyNameList" open="(" separator="," close=")">
                #{item}
              </foreach>
            )
    </delete>

    <delete id="delCompanyByBuildingId" parameterType="java.util.List">
        DELETE FROM company_building WHERE building_id IN
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <delete id="delBuildingByParkId" parameterType="int">
        DELETE FROM building WHERE park_id=#{parkId}
    </delete>

    <delete id="delParkByName" parameterType="java.lang.String">
        DELETE FROM park WHERE `name`=#{parkName}
    </delete>

    <sql id="building_content">
        building_id as buildingId, `name` as `name`, park_id as parkId, img_url as imgUrl
    </sql>

    <select id="queryBuildingByParkId" parameterType="int" resultType="com.bbd.wtyh.domain.BuildingDO">
        SELECT <include refid="building_content" /> FROM building WHERE park_id=#{parkId}
    </select>

    <select id="queryParkIdByName" parameterType="java.lang.String" resultType="int">
        SELECT park_id as parkId FROM park WHERE `name`=#{parkName}
    </select>

    <insert id="addPark" parameterType="com.bbd.wtyh.domain.ParkDO">
        INSERT INTO park(`name`, area_id, img_url, create_by, create_date, update_date) VALUES(#{name},#{areaId},#{imgUrl},#{createBy},SYSDATE(), SYSDATE())
    </insert>

    <select id="queryCompanyIdByName" parameterType="java.lang.String" resultType="int">
        SELECT company_id as companyId FROM company WHERE `name`=#{companyName}
    </select>

    <insert id="addCompanyBuilding" parameterType="java.util.List">
        INSERT INTO company_building(company_id, building_id, create_by, create_date, update_date) VALUES
        <foreach collection="list" separator="," item="item">
            (#{item.companyId},#{item.buildingId},#{item.createBy},SYSDATE(),SYSDATE())
        </foreach>
    </insert>

    <insert id="addExcelComAndBuilding" parameterType="java.util.List">
        INSERT INTO park_company_import(import_no, company_name, building_name, company_id, building_id, error_company, error_building, create_by, create_date, update_date) VALUES
        <foreach collection="list" separator="," item="item">
            (#{item.importNo},#{item.companyName},#{item.buildingName},#{item.companyId},#{item.buildingId},#{item.errorCompany},#{item.errorBuilding},#{item.createBy},SYSDATE(),SYSDATE())
        </foreach>
    </insert>

    <select id="queryImportNo" resultType="java.lang.String">
        SELECT UUID() FROM DUAL
    </select>

    <select id="queryImportContentByNo" parameterType="java.lang.String" resultType="com.bbd.wtyh.domain.ParkCompanyImportDO">
        SELECT
            company_name as companyName,
            building_name as buildingName,
            company_id as companyId,
            building_id as buildingId,
            error_company as errorCompany,
            error_building as errorBuilding
        FROM
            park_company_import
        WHERE import_no=#{importNo}
    </select>

    <select id="queryBuildingByParkAndName" resultType="com.bbd.wtyh.domain.BuildingDO">
        SELECT <include refid="building_content" /> FROM building WHERE park_id=#{parkId} AND `name`=#{buildingName}
    </select>

    <select id="queryCompanyByBuildingId" resultType="com.bbd.wtyh.domain.CompanyDO" parameterType="int">
        SELECT
            `name` as `name`,
            legal_person as legalPerson,
            registered_type as registeredType,
            business_type as businessType,
            risklevel as riskLevel
        FROM
            company
        WHERE
            company_id IN (SELECT company_id FROM company_building WHERE building_id=#{buildingId})
    </select>

</mapper>